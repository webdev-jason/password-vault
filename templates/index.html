<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault</title>
    <!-- Link to our new Design System -->
    <!-- We add ?v=1 to force the browser to reload the CSS if you change it later -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=1">
</head>
<body>

    <div class="app-container">
        
        <!-- SECTION: LOGIN -->
        <div id="login-section" class="card">
            <h2>üîê Secure Vault</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">Enter credentials to unlock</p>
            
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="login-user" autocomplete="off">
            </div>
            
            <div class="input-group">
                <label>Master Password</label>
                <input type="password" id="login-pass">
            </div>
            
            <div class="input-group">
                <label>2FA Code</label>
                <input type="text" id="login-code" placeholder="000 000" maxlength="6" style="text-align: center; letter-spacing: 2px;">
            </div>

            <button class="btn btn-primary" onclick="attemptLogin()">Unlock Vault</button>
            <div id="error-msg" class="text-error"></div>
        </div>

        <!-- SECTION: DASHBOARD -->
        <div id="vault-section" class="hidden">
            
            <!-- Header -->
            <div class="header-row">
                <h2>My Passwords</h2>
                <a href="#" onclick="logout()" class="logout-link">Log Out</a>
            </div>

            <!-- Add New Password Card -->
            <div class="card">
                <div class="input-group">
                    <input type="text" id="new-site" placeholder="Website (e.g. Netflix)">
                </div>
                <div class="input-group">
                    <input type="text" id="new-user" placeholder="Username / Email">
                </div>
                <div class="input-group" style="display: flex;">
                    <input type="text" id="new-pass" placeholder="Password">
                    <!-- SVG Icon for Dice -->
                    <button class="btn btn-generate" onclick="generateRandomPassword()" title="Generate Random">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <circle cx="16" cy="8" r="2"></circle>
                            <circle cx="8" cy="16" r="2"></circle>
                            <circle cx="8" cy="8" r="2"></circle>
                            <circle cx="16" cy="16" r="2"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                    </button>
                </div>
                <button class="btn btn-primary" onclick="addPassword()">Save Password</button>
            </div>

            <!-- List Area -->
            <div id="password-list">
                <!-- Javascript will populate this -->
            </div>
        </div>

    </div>

    <script>
        let sessionToken = ""; 
        let masterKeyCache = ""; 

        /* --- 1. UTILITIES --- */
        function generateRandomPassword() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()";
            let password = "";
            for (let i = 0; i < 16; i++) {
                const randomValues = new Uint32Array(1);
                window.crypto.getRandomValues(randomValues);
                password += chars[randomValues[0] % chars.length];
            }
            document.getElementById('new-pass').value = password;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback could go here
                alert("Copied to clipboard!");
            });
        }

        function logout() {
            location.reload();
        }

        /* --- 2. API CALLS --- */
        async function attemptLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const code = document.getElementById('login-code').value;

            // Simple UI loading state could go here
            const btn = document.querySelector('#login-section .btn');
            btn.innerText = "Verifying...";
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: user, password: pass, "2fa_code": code })
                });

                const result = await response.json();

                if (response.ok) {
                    sessionToken = result.token;
                    masterKeyCache = pass;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('vault-section').classList.remove('hidden');
                    loadPasswords();
                } else {
                    document.getElementById('error-msg').innerText = result.error || "Login Failed";
                    btn.innerText = "Unlock Vault";
                }
            } catch (e) {
                document.getElementById('error-msg').innerText = "Server Error";
                btn.innerText = "Unlock Vault";
            }
        }

        async function loadPasswords() {
            const response = await fetch('/api/get_passwords', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': sessionToken 
                },
                body: JSON.stringify({ master_password: masterKeyCache })
            });
            
            if (response.status === 401) return logout();

            const passwords = await response.json();
            const listDiv = document.getElementById('password-list');
            listDiv.innerHTML = ""; 

            passwords.forEach(p => {
                const item = document.createElement('div');
                item.className = 'vault-item';
                
                // We use SVG icons for the buttons now
                item.innerHTML = `
                    <div class="vault-info">
                        <span class="vault-site">${p.site}</span>
                        <span class="vault-user">${p.username}</span>
                    </div>
                    <div class="vault-actions">
                        <button class="btn-icon" onclick="copyToClipboard('${p.password}')" title="Copy Password">
                            <!-- Copy Icon -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                        <button class="btn-icon" onclick="deletePassword(${p.id})" title="Delete" style="color: var(--danger);">
                            <!-- Trash Icon -->
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        async function addPassword() {
            const site = document.getElementById('new-site').value;
            const user = document.getElementById('new-user').value;
            const pass = document.getElementById('new-pass').value;

            if(!site || !pass) return alert("Site and Password are required");

            const response = await fetch('/api/add_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': sessionToken
                },
                body: JSON.stringify({
                    master_password: masterKeyCache,
                    site_name: site,
                    site_username: user,
                    site_password: pass
                })
            });

            if (response.ok) {
                document.getElementById('new-site').value = "";
                document.getElementById('new-user').value = "";
                document.getElementById('new-pass').value = "";
                loadPasswords();
            }
        }

        async function deletePassword(id) {
            if(!confirm("Are you sure you want to delete this?")) return;

            const response = await fetch('/api/delete_password', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'x-access-token': sessionToken
                },
                body: JSON.stringify({ id: id })
            });

            if(response.ok) loadPasswords();
        }
    </script>
</body>
</html>